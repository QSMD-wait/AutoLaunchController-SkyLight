AutoLaunchController‑SkyLight 项目总体设计与逻辑蓝图

> 说明：本蓝图仅包含推荐操作指定（建议做法、推荐结构、推荐机制），不包含任何“必须”“强制”“规定性”措辞。  
> 目标是为后续工程实现提供一套完整、客观、可落地的设计参考。

---

一、项目定位与总体目标

1.1 项目定位

- 项目名称： AutoLaunchController‑SkyLight  
- 平台定位： Windows 桌面自动化平台（Desktop Automation Platform）  
- 技术栈： C#、WPF、WPF‑UI（现代 Fluent 风格 UI 库）  
- 核心能力：
  - 基于 触发器（Trigger）–判断器（Condition）–执行器（Action/Executor） 的自动化规则体系
  - 支持复杂流程编排（Flow Orchestration）
  - 支持丰富的 UI/信息显示执行器（如进度条、通知、交互框）
  - 支持高权限操作（管理员模式）与安全控制（身份验证、敏感功能分级）
  - 支持单 EXE 部署、自动初始化与目录自修复
  - 支持外部配置加载（如 U 盘配置）与配置迁移/打包

1.2 总体目标

- 可扩展性（Extensibility）： 推荐通过插件化机制扩展触发器、判断器、执行器与流程节点。
- 可维护性（Maintainability）： 推荐采用清晰分层架构与统一接口规范。
- 可观察性（Observability）： 推荐提供日志、状态监控、执行轨迹等可视化能力。
- 可携带性（Portability）： 推荐支持单 EXE 运行与目录自修复，适配“冰点还原”类环境。
- 安全性（Security）： 推荐对高权限与危险操作进行分级、鉴权与显式确认。

---

二、总体架构与分层设计

2.1 推荐分层结构

建议采用四层架构：

1. UI 层（UI Layer）：
   - 技术：WPF + WPF‑UI
   - 职责：规则管理、流程编排、状态展示、日志查看、配置编辑、初始化导航
2. 应用层（Application Layer）：
   - 职责：规则引擎（Rule Engine）、流程编排器（Flow Orchestrator）、触发器调度、执行器调用、权限模式管理
3. 领域层（Domain Layer）：
   - 职责：定义 Trigger/Condition/Action/FlowNode 等核心抽象模型与接口
   - 包含：规则模型、流程模型、执行上下文（Execution Context）、敏感级别（Sensitivity Level）等
4. 基础设施层（Infrastructure Layer）：
   - 职责：日志系统、配置系统、文件系统访问、系统 API 调用、进程/窗口/网络监控、目录自修复、外部配置加载

2.2 核心模块划分（推荐）

- Rule Engine 模块： 负责规则的加载、保存、执行调度。
- Trigger 模块： 提供多种触发器实现与统一触发接口。
- Condition 模块： 提供判断器实现与组合逻辑支持。
- Action/Executor 模块： 提供执行器实现，包括系统操作与 UI/信息显示类执行器。
- Flow Orchestrator 模块： 提供流程节点模型与执行引擎。
- Security & Auth 模块： 提供身份验证器与敏感级别管理。
- Bootstrap & Self‑Healing 模块： 提供单 EXE 启动、目录初始化与自修复逻辑。
- External Config & Migration 模块： 提供外部配置加载、配置打包与迁移能力。

---

三、规则与流程模型设计（逻辑层面）

3.1 规则（Rule）模型

建议将“规则”定义为：

- 组成：
  - 一个或多个触发器（Trigger）
  - 零个或多个判断器（Condition）
  - 一个或多个执行器（Action）
  - 可选的流程编排（Flow）引用
- 行为：
  - 当触发器产生事件时，依次执行判断器
  - 判断通过时，执行执行器或启动流程

3.2 流程（Flow）模型

建议将“流程”视为由多个节点（Node）组成的有向图：

- 节点类型（推荐）：
  - Trigger Node： 触发入口节点
  - Condition Node： 条件判断节点
  - Action Node： 执行器节点
  - Parallel Node： 并行执行节点
  - Branch Node： 条件分支节点
  - Delay Node： 延迟/等待节点
  - Loop Node： 循环节点
  - Interaction Node： 用户交互节点（如对话框）
  - Display Node： UI/信息显示类执行器节点（如进度条、通知）
- 执行上下文（Execution Context）：
  - 推荐包含：触发事件数据、流程变量、执行结果、用户输入、环境信息等。
- 执行模式（Execution Mode）：
  - 推荐支持：
    - 正常执行（Normal）
    - 仅一次执行（Once）
    - 执行后删除（RunAndDelete，建议标记为危险模式）

---

四、触发器体系设计（Trigger System）

4.1 触发器抽象

- 统一接口（推荐）：
  - 含：启动（Start）、停止（Stop）、配置（Configure）、事件回调（OnTriggered）
- 事件模型：
  - 推荐定义 TriggerEvent，包含：
    - 触发时间
    - 触发类型
    - 相关上下文（如进程信息、文件路径、网络状态等）

4.2 推荐触发器类型

1. 系统级触发器（System Triggers）：
   - CPU/内存/磁盘阈值触发
   - 网络状态变化
   - 电源事件（如睡眠、唤醒）
   - 系统空闲时间（Idle Time）
2. 应用级触发器（Application Triggers）：
   - 进程启动/退出
   - 窗口出现/消失
   - 窗口标题变化
   - 前台窗口变化
3. 输入级触发器（Input Triggers）：
   - 全局热键（Global Hotkey）
   - 键盘序列触发
   - 鼠标手势触发
4. 文件/目录触发器（File Triggers）：
   - 文件创建/删除/修改
   - 目录监控
   - 文件大小变化
   - 文件内容匹配（如正则）
5. 网络触发器（Network Triggers）：
   - 端口监听
   - HTTP 请求触发
   - Ping 结果触发
   - Webhook 触发
6. 时间触发器（Time Triggers）：
   - 定时器（固定间隔）
   - Cron 表达式触发
   - 日程触发（指定日期时间）
7. 外部设备触发器（External Device Triggers）：
   - U 盘插入/移除触发
   - 指定路径存在配置文件触发（用于外部配置加载）

---

五、判断器体系设计（Condition System）

5.1 判断器抽象

- 统一接口（推荐）：
  - 输入：TriggerEvent 或当前执行上下文
  - 输出：布尔结果（True/False）
- 组合能力：
  - 推荐支持 AND/OR/NOT 组合，形成条件树（Condition Tree）。

5.2 推荐判断器类型

- 数值判断器（Numeric Condition）：如 CPU 使用率 > X。
- 字符串判断器（String Condition）：如窗口标题包含某关键字。
- 布尔判断器（Boolean Condition）：如某状态标志为真。
- 正则判断器（Regex Condition）：如文件内容匹配某模式。
- 组合判断器（Composite Condition）：支持嵌套逻辑树。

---

六、执行器体系设计（Action/Executor System）

6.1 执行器抽象

- 统一接口（推荐）：
  - 输入：执行上下文（Execution Context）
  - 输出：执行结果（ActionResult），可包含成功/失败状态与返回值。
- 敏感级别（Sensitivity Level）：
  - 推荐为每个执行器定义敏感级别，如：
    - 普通（Normal）
    - 提示级（Warning）
    - 高风险（High‑Risk）
  - 高风险执行器建议仅在管理员模式下可用，并建议绑定身份验证器。

6.2 推荐执行器类型

6.2.1 系统操作类执行器

- 启动程序（Launch Application）
- 终止进程（Kill Process）
- 修改系统设置（如音量、网络适配器状态等）
- 操作文件/目录（复制、移动、删除）
- 调用脚本（如 PowerShell、CMD、外部脚本）

6.2.2 UI/信息显示类执行器

1. 顶部贴边多功能进度条（Top‑Dock Progress Bar）：
   - 推荐用于显示：
     - 自动化流程进度
     - 系统状态（如 CPU、网络）
     - 当前规则执行阶段
   - 推荐特性：
     - 贴顶悬浮显示
     - 支持多段颜色与动画
     - 支持点击展开详情
     - 支持自动显示/自动隐藏
2. Toast 通知（Toast Notification）：
   - 推荐用于轻量提示与执行结果反馈。
   - 推荐特性：
     - 标题、内容、图标、按钮
     - 自动消失
     - 支持点击回调（用于后续流程）
3. 通知中心（Notification Center）：
   - 推荐用于汇总历史通知与执行记录。
   - 推荐特性：
     - 列表展示
     - 搜索与过滤
     - 按规则/类型分类
4. 交互框（Interactive Dialog）：
   - 推荐用于需要用户确认或输入的场景。
   - 推荐特性：
     - 模态/非模态
     - 支持输入框、下拉框、按钮组
     - 支持多步向导（Wizard）

6.2.3 安全敏感类执行器（建议高风险标记）

- 系统级敏感操作执行器（如修改关键系统配置）
- 自删除执行器（Self‑Delete Executor）：
  - 推荐支持：
    - 删除自身 EXE
    - 删除自身目录
    - 删除临时数据
  - 推荐强约束：
    - 建议仅在管理员模式下可见
    - 建议必须绑定身份验证器
    - 建议执行前二次确认并记录日志

---

七、流程编排器设计（Flow Orchestrator）

7.1 流程节点模型

- 推荐将流程视为由节点（Node）与连线（Edge）组成的有向图。
- 每个节点建议包含：
  - 节点类型（NodeType）
  - 节点配置（NodeConfig）
  - 输入/输出端口定义（Ports）
  - 关联执行器或判断器引用（如 ActionId、ConditionId）

7.2 流程执行引擎

- 推荐支持：
  - 顺序执行（Sequential）
  - 并行执行（Parallel）
  - 条件分支（Branch）
  - 循环（Loop）
  - 延迟/等待（Delay）
  - 用户交互（Interaction）
- 推荐提供：
  - 执行上下文传递（Context Passing）
  - 中断（Cancel）
  - 暂停/恢复（Pause/Resume）
  - 执行日志记录（Execution Log）

7.3 流程执行模式（Execution Modes）

- 推荐支持：
  - 正常执行（Normal）：每次触发均可执行。
  - 仅一次执行（Once）：执行一次后标记为已完成。
  - 执行后删除（RunAndDelete）：执行后从配置中移除（建议视为高风险模式）。

---

八、UI 与信息架构设计（WPF + WPF‑UI）

8.1 推荐 UI 模块

- 规则列表页（Rule List）
- 规则编辑器（Rule Editor）
- 流程编排器（Flow Builder，可视化节点编辑）
- 触发器选择器（Trigger Picker）
- 判断器构建器（Condition Builder）
- 执行器选择器（Action Picker）
- 日志查看器（Log Viewer）
- 通知中心（Notification Center）
- 系统状态监控面板（System Monitor）
- 初始化导航向导（Onboarding Wizard）
- 设置中心（Settings），包括：
  - 权限模式设置
  - 身份验证器配置
  - 外部数据目录设置
  - 外部配置加载策略

8.2 风格与交互建议

- 推荐采用 Fluent Design 风格，结合 WPF‑UI 控件。
- 推荐使用 Teal（青色）作为主品牌色。
- 推荐保持界面模块化、信息层级清晰、操作路径可预期。

---

九、单 EXE 部署与目录自修复设计

9.1 单 EXE 部署策略

- 推荐初始仅提供一个 EXE 文件：
  - AutoLaunchController-SkyLight.exe
- EXE 启动后建议自动检查同级目录结构：
  - 若不存在，则自动创建推荐目录结构。

9.2 推荐目录结构（示例）

`text
AutoLaunchController-SkyLight.exe
/Config
/Logs
/Modules
/Triggers
/Actions
/UI
/Data
/Temp
/Config/version.json
`

- Config：配置文件与版本信息。
- Logs：日志文件。
- Modules：插件模块（触发器、执行器等）。
- Triggers / Actions：可选的分类目录。
- UI：UI 资源（主题、图标、模板）。
- Data：持久化数据。
- Temp：临时文件。

9.3 目录自修复与版本化

- 推荐在启动时：
  - 检查目录是否存在，若缺失则创建。
  - 检查关键文件是否存在，若缺失则从 EXE 内嵌资源恢复。
  - 检查 Config/version.json 中的目录结构版本：
    - 若版本落后，建议执行目录升级与配置迁移。
- 推荐将默认配置、内置模块与 UI 资源以嵌入资源形式存放于 EXE 内部，以便恢复。

---

十、初始化导航与启动模式设计

10.1 初始化导航（Onboarding Wizard）

- 推荐在首次运行或检测到“未初始化状态”时自动进入：
  1. 欢迎页
  2. 目录结构创建进度展示
  3. 默认配置生成说明
  4. 模块扫描与加载说明
  5. 完成页与引导用户创建首个规则/流程

10.2 启动模式（Startup Modes）

- 推荐支持：
  - 正常模式：显示主 UI。
  - 静默模式（Silent）：不显示主窗口，仅托盘图标或完全后台运行。
- 推荐提供：
  - 启动参数控制（如 --silent）
  - 配置项控制（如“开机自启时使用静默模式”）

10.3 启动时执行器（Startup Flow）

- 推荐支持配置“应用启动时执行的流程组”：
  - 可用于初始化任务、环境检测、状态同步等。
  - 若包含敏感执行器，建议与管理员模式与身份验证策略联动。

---

十一、管理员模式与高权限设计

11.1 管理员模式（Admin Mode）

- 推荐提供两种运行模式：
  - 普通模式（Standard Mode）：默认模式，限制敏感执行器与高风险流程。
  - 管理员模式（Admin Mode）：通过 UAC 提权后运行，允许使用高敏感功能。
- 推荐在 UI 中明确显示当前模式状态。

11.2 高权限 UI 行为

- 在管理员模式下，建议允许：
  - 通知、进度条等 UI 执行器以高优先级置顶显示。
  - 某些系统级操作在高权限下执行，以提高成功率。

11.3 敏感级别与权限控制

- 推荐为执行器与流程组定义敏感级别：
  - 普通（Normal）
  - 提示级（Warning）
  - 高风险（High‑Risk）
- 推荐策略：
  - 高风险执行器建议仅在管理员模式下可见或可用。
  - 高风险流程组建议默认处于禁用状态，需显式启用。

---

十二、身份验证器与安全策略设计

12.1 身份验证器（Authenticator）

- 推荐支持多种验证方式：
  - 本地密码验证（Local Password）
  - 口令短语（Passphrase）
  - 外部令牌文件（Token File，如 U 盘上的特定文件）
  - 组合验证（如密码 + 令牌）
- 推荐可配置验证策略：
  - 每次操作都验证
  - 在一定时间内记住验证结果
  - 当前会话内记住验证结果

12.2 身份验证应用场景（推荐）

- 高风险执行器的执行
- 高风险流程组的启用与执行
- 外部配置文件的加载与执行
- 自删除执行器的配置与执行
- 管理员模式的某些关键操作（如修改安全策略）

---

十三、外部配置文件加载与 U 盘集成

13.1 外部配置文件加载机制

- 推荐通过“U 盘插入触发器”检测新卷挂载。
- 推荐在指定路径查找配置文件，例如：
  - \SkyLight\Config\profile.json
- 推荐配置文件包含：
  - 流程组定义
  - 触发器/执行器配置
  - 元数据（作者、版本、用途说明）
  - 安全信息（签名、校验值等）

13.2 鉴权与执行策略

- 推荐在加载外部配置前：
  - 使用身份验证器进行鉴权。
  - 校验配置文件签名或校验值。
- 推荐提供多种执行策略：
  - 自动执行
  - 提示后执行
  - 仅导入，不立即执行
- 对于外部配置中包含的高风险执行器或流程组：
  - 推荐导入时默认禁用。
  - 推荐在本地 UI 中由管理员显式启用并通过鉴权。

---

十四、自删除执行器与危险功能控制

14.1 自删除执行器（Self‑Delete Executor）

- 推荐功能范围：
  - 删除自身 EXE
  - 删除自身目录
  - 删除临时数据
- 推荐安全约束：
  - 建议仅在管理员模式下可见。
  - 建议必须绑定身份验证器。
  - 建议执行前显示详细风险说明并要求二次确认。
  - 建议执行前写入日志（可选写入外部目录）。

14.2 危险功能迁移策略

- 在配置迁移或打包时，建议：
  - 扫描并标记高风险执行器与流程组。
  - 在导出包中将其标记为“禁用”状态。
  - 在导入时提示存在高风险内容，并建议由本机管理员决定是否启用。

---

十五、配置迁移与打包设计

15.1 配置打包内容（推荐）

- 规则与流程组定义
- 触发器与执行器配置
- UI 配置（如主题、布局）
- 不建议包含：
  - 与本机强绑定的路径
  - 机器唯一标识
  - 明文敏感信息

15.2 打包模式

- 推荐支持：
  - 纯配置打包（不含模块）
  - 完整打包（含模块与资源）

15.3 迁移时的安全处理

- 推荐在打包时：
  - 自动禁用高风险执行器与流程组。
- 推荐在导入时：
  - 提示存在高风险内容。
  - 建议由管理员在本机环境中逐项启用。

---

十六、冰点还原类环境适配策略

16.1 无状态运行与自恢复

- 推荐设计为：
  - 即使应用目录被清空，EXE 仍可：
    - 自动重建目录结构
    - 自动恢复默认配置
    - 自动恢复内置模块与 UI 资源
- 推荐将关键资源内嵌于 EXE 中，以便恢复。

16.2 外置数据目录支持

- 推荐支持指定外置数据目录，例如：
  - 启动参数：--data "D:\SkyLightData"
  - 设置项：在 UI 中配置数据目录位置
- 推荐将持久化数据（如日志、用户配置、外部导入配置）写入外置目录，以减少冰点还原影响。

16.3 日志策略

- 推荐提供多种日志策略：
  - 写入本地目录（适用于非还原环境）
  - 写入外置目录（适用于还原环境）
  - 内存日志（仅当前会话可见）

---

十七、日志与可观察性设计

17.1 日志内容（推荐）

- 系统运行日志（启动、关闭、异常）
- 规则与流程执行日志（触发时间、结果、耗时）
- 安全相关日志（管理员模式切换、身份验证结果、高风险操作）
- 外部配置加载日志（来源、校验结果、导入内容摘要）

17.2 可视化展示

- 推荐提供：
  - 日志查看器（按时间、类型、规则过滤）
  - 执行轨迹视图（Flow Execution Trace）
  - 状态监控面板（如当前运行中的流程、触发器状态）

---

十八、扩展机制与插件化设计

18.1 插件化原则（推荐）

- 新增触发器、判断器、执行器与流程节点时：
  - 建议不修改核心框架代码。
  - 建议通过接口与元数据（Attribute）进行自动发现与加载。
- 推荐使用模块目录（如 /Modules）存放插件。

18.2 元数据与自动发现

- 推荐为插件定义元数据：
  - 名称、描述、版本
  - 类型（Trigger/Condition/Action/FlowNode）
  - 敏感级别（Sensitivity Level）
- 推荐在启动时扫描模块目录并加载插件：
  - UI 层可根据元数据自动生成配置界面与选择器列表。

---

十九、总结性建议

- 推荐将 AutoLaunchController‑SkyLight 视为一个 “可扩展的桌面自动化平台”，而非单一工具。
- 推荐在设计时始终兼顾：
  - 自动化能力
  - UI 表达能力
  - 安全与权限控制
  - 部署与迁移便利性
  - 冰点还原环境适配能力
- 推荐在工程实现阶段：
  - 先实现核心抽象与基础设施（规则模型、流程引擎、目录自修复、日志系统）。
  - 再逐步扩展触发器、执行器与 UI 模块。
  - 最后完善管理员模式、安全策略与外部配置加载等高级能力。
